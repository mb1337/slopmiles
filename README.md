# Slop Miles

AI-powered running coach for iOS. Generate personalized training plans using OpenAI or Anthropic, with structured workouts pushed to Apple Watch.

## Features

- **AI Training Plans** — Multi-week plans generated by GPT-4o or Claude, personalized to your fitness level, schedule, and goals
- **Deterministic Running Math** — AI uses function calling (tool use) to invoke VDOT calculators, pace converters, and HR zone formulas instead of guessing
- **Apple Watch Integration** — Structured workouts with pace targets and intervals pushed to the Watch Workout app via WorkoutKit
- **HealthKit Integration** — Reads your running history, VO2max, and heart rate data to inform plan generation
- **Weather-Aware Scheduling** — Checks Open-Meteo forecasts to schedule indoor/outdoor workouts appropriately
- **iCloud Sync** — Plans sync across devices via SwiftData + CloudKit
- **Bring Your Own Key** — No backend server. API keys stored in iOS Keychain, never leave your device.

## Requirements

- iOS 18.0+
- Xcode 16.0+
- An API key from [Anthropic](https://console.anthropic.com/) or [OpenAI](https://platform.openai.com/)
- Apple Watch (optional, for WorkoutKit features)

## Architecture

### AI Tool Use

Instead of asking the LLM to do running math (unreliable), Slop Miles defines **7 tools** that the AI calls during plan generation:

| Tool | Purpose |
|------|---------|
| `calculate_vdot` | Derive VDOT fitness score from race results |
| `get_training_paces` | Get easy/marathon/threshold/interval/repetition paces |
| `project_race_time` | Predict finish times at any distance |
| `calculate_hr_zones` | Heart rate training zones (Friel 5-zone model) |
| `convert_pace` | Convert between min/km, min/mile, km/h, mph |
| `check_mileage_progression` | Validate weekly volume safety (10% rule) |
| `get_weather_forecast` | Open-Meteo weather for workout scheduling |

The AI conversation loop runs entirely client-side:

```
App → AI: "Create a 12-week half marathon plan for this runner"
AI → App: tool_use(calculate_vdot, get_training_paces)
App → AI: { vdot: 50.3, easy: "5:30/km", threshold: "4:32/km", ... }
AI → App: tool_use(check_mileage_progression, get_weather_forecast)
App → AI: { safe: true, ... }
AI → App: { "name": "Half Marathon Plan", "weeks": [...] }  // Final JSON
```

### Data Flow

```
SwiftData (iCloud sync) ← ResponseParser ← AI JSON
                        → WorkoutMapper → WorkoutKit → Apple Watch
HealthKit → RunningStats → PromptBuilder → AI Prompt
Keychain → API Keys (device-local, never synced)
```

## Project Structure

```
SlopMiles/
├── App/            # Entry point, AppState
├── Models/         # SwiftData models (TrainingPlan, PlannedWorkout, etc.)
├── Services/
│   ├── AI/         # Provider protocol, Anthropic/OpenAI implementations, tool definitions
│   ├── Tools/      # VDOT, HR zones, pace converter, mileage checker, weather
│   ├── Health/     # HealthKit service
│   ├── Workout/    # WorkoutKit service, workout mapper
│   └── Keychain/   # Keychain service for API keys
├── Views/
│   ├── Onboarding/ # 7-step onboarding flow
│   ├── Dashboard/  # Current week, next workout
│   ├── TrainingPlan/ # Plan list, detail, generation
│   ├── Workout/    # Workout detail view
│   ├── History/    # HealthKit run history
│   └── Settings/   # AI provider, profile, about
└── Utilities/      # Constants, unit conversion, date formatting
```

## Setup

1. Clone the repository
2. Install [XcodeGen](https://github.com/yonaskolb/XcodeGen): `brew install xcodegen`
3. Generate the Xcode project: `cd SlopMiles && xcodegen generate`
4. Open `SlopMiles.xcodeproj` in Xcode
5. Set your development team in project settings
6. Build and run on a device (WorkoutKit requires real hardware)

### Without XcodeGen

You can also open the Swift files directly in Xcode by creating a new iOS project and adding the source files and SPM dependency (`https://github.com/mb1337/vdot-calc-swift`).

## Testing

Run the test suite in Xcode or via command line:

```bash
xcodebuild test -scheme SlopMiles -destination 'platform=iOS Simulator,name=iPhone 16'
```

Tests cover:
- VDOT calculations and pace accuracy
- Heart rate zone formulas
- Mileage progression safety checks
- Tool executor routing
- Prompt construction
- Response JSON parsing
- WorkoutKit mapping

## License

MIT. See [LICENSE](LICENSE).
